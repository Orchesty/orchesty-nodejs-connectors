import Form from 'pipes-nodejs-sdk/dist/lib/Application/Model/Form/Form';
import Field from 'pipes-nodejs-sdk/dist/lib/Application/Model/Form/Field';
import FieldType from 'pipes-nodejs-sdk/dist/lib/Application/Model/Form/FieldType';
import { ApplicationInstall } from 'pipes-nodejs-sdk/dist/lib/Application/Database/ApplicationInstall';
import { FORM } from 'pipes-nodejs-sdk/dist/lib/Application/Base/AApplication';
import {
  DescribeClustersCommand, DescribeClustersCommandInput, DescribeClustersCommandOutput,
  RedshiftClient,
} from '@aws-sdk/client-redshift';
import { Client } from 'pg';
import AAwsApplication, {
  CREDENTIALS, KEY, LATEST, REGION, REGIONS, SECRET, VERSION,
} from '../AAwsApplication';

const DB_PASSWORD = 'DbPassword';

const HOST = 'host';
const PORT = 'Port';
const DBNAME = 'DBName';
const MASTER_USER = 'MasterUsername';

export default class RedshiftApplication extends AAwsApplication {
  public getDescription = (): string => 'Amazon Redshift is a fast, simple, cost-effective data warehousing service.';

  public getName = (): string => 'redshift';

  public getPublicName = (): string => 'Amazon Redshift';

  public getSettingsForm = (): Form => {
    const form = new Form();
    form
      .addField(new Field(FieldType.TEXT, KEY, 'Key', undefined, true))
      .addField(new Field(FieldType.TEXT, SECRET, 'Secret', undefined, true))
      .addField(new Field(FieldType.PASSWORD, DB_PASSWORD, 'Database Password', undefined, true))
      .addField((new Field(FieldType.SELECT_BOX, REGION, 'Region', '', true)).setChoices(REGIONS));

    return form;
  };

  public getRedshiftClient = (applicationInstall: ApplicationInstall): RedshiftClient => {
    const settings = applicationInstall.getSettings()[FORM];

    return new RedshiftClient([
      /* eslint-disable @typescript-eslint/naming-convention */
      {
        [CREDENTIALS]: {
          KEY: settings[KEY],
          SECRET: settings[SECRET],
        },
      },
      {
        [REGION]:
          settings[REGION],
      },
      {
        [VERSION]:
        LATEST,
      },
    ]);
  };

  public async setApplicationSettings(
    _applicationInstall: ApplicationInstall,
    settings: [],
  ): Promise<ApplicationInstall> {
    const applicationInstall = await super.setApplicationSettings(_applicationInstall, settings);

    const input: DescribeClustersCommandInput = {};
    const command = new DescribeClustersCommand(input);
    const response = await this.getRedshiftClient(applicationInstall)
      .send(command) as DescribeClustersCommandOutput;

    if (!response.Clusters) {
      throw new Error('Login into application was unsuccessful.');
    }

    const cluster = response.Clusters[0];

    return applicationInstall.setSettings(
      {
        CLUSTER_IDENTIFIER: cluster.ClusterIdentifier,
        MASTER_USER: cluster.MasterUsername,
        DB_PASSWORD: applicationInstall.getSettings()[FORM][DB_PASSWORD],
        DBNAME: cluster.DBName,
        HOST: cluster.Endpoint?.Address,
        PORT: cluster.Endpoint?.Port,
      },
    );
  }

  public getConnection = async (applicationInstall: ApplicationInstall): Promise<Client> => {
    const settings = applicationInstall.getSettings();

    const client = new Client({
      user: settings[MASTER_USER],
      host: settings[HOST],
      database: settings[DBNAME],
      password: settings[DB_PASSWORD],
      port: settings[PORT],
    });
    try {
      await client.connect();
    } catch (e) {
      throw new Error('Connection to Redshift db was unsuccessful.');
    }
    return client;
  };

  // eslint-disable-next-line max-len
  public getLogo = (): string => 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAACXBIWXMAAAsTAAALEwEAmpwYAAAUR0lEQVR4nO3cQYic93nHcTsODXEc5LZpjQvWrkRKqBzRg08BUyetaQ21a8+GAXtWNTRQXY3ig3qTT616MIo8K+1O4xyq0ouuhspFl0JFoGE1Yxz7YhBpDwlOWxNw2zSpLW3fWa3tfSRZ2nd3Zt53/s/nAz+U46408z5fRZ696y4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACYuYPdwb6HX7zw9a8e+4fHMu93X7z49e5gfV/Tfx4AMFWHuiv3LfbWji8ur753+NjrVw9/+/WN3Ltwbak/fH9pZXjy6VOj+5v+8wGAidp++BeX1zbGEwBbAbAy2ticEACgFLc6/J8EwIVrzR/gprctAIQAAPPudodfANwhAIQAAPNmJ4d/2z8BCIDbBYAQAKDt6hx+ARAC4PbHXwgA0Ea7OfwCIG7HASAEAGjaXg7/xwHQguPbhtUOACEAwKxN4vALgAkFgBAAYNomefgFwLa9OIEAEAIATNo0Dr8AmFIACAEA9mqah18ATDkAhAAAdc3i8AuAGQWAEADgTmZ5+AXAjANACABwoyYOvwBoKACEAABNHn4B0HAACAGAfNpw+AVASwJACACUr02HXwC0LACEAEB52nj4BUBLA0AIAMy/Nh9+AdDyABACAPNnHg6/AJiTABACAO03T4dfAMxZAAgBgPaZx8MvAOY0AIQAQPPm+fALgDkPACEA0JyF5bV3mj7gAiB5AGyt0x9eafr9AJBG9Tf/Hzd9wAWAALi+4btNvx8A0hAAhUwAAFCHAChkAgCAOgRAIRMAANQhAAqZAACgDgFQyAQAAHUIgEImAACoQwAUMgEAQB0CoJAJAADqEACFTAAAUIcAKGQCAIA6BEAhEwAA1CEACpkAAKAOAVDIBAAAdQiAQiYAAKhDABQyAQBAHQKgkAkAAOoQAIVMAABQhwAoZAIAgDoEQCETAADUIQAKmQAAoA4BUMgEAMBsHewO9v3RX/7T1544/c7nmv5adkMAFDIB0JgvP3H6c189+vdf6w7W9zX9tQAzcKi7ct9ib+14dUDfe+KvL12pHmAfLPVH69VD7OTSmTeeevrU6P6mv8adEACFTADMzINHB/cefG7w6Pj9v7C8erF6Df78d/78b3+01B++P37/z8t7H6hp++H/6ABtBUB4mHX6ow83g6A/Ol397+4z/X/59aa/9lsRAIVMAEzN+D1/oDd4vDr2L40P/kJv7Rc3vgY3A+Cj70MIQFludfhvFwC3Wqc/vNJZGQ46Z4bPd7+zvr/p72lMABQyATAxB4+c/c0Dz609VR37k9Xra71631+902swBIAQgDLc7vDXDYBbBkF/dG6pPzr6zZXRw018fwKgkAmAXdu/PHiw+ht+tzr4pzcP/vLqtbqvwVsGgBCA+bSTw7/XALj5QTH6SfXr+eqB8cIzZy8/ctfGxt3T/j4FQCETADu2v3f24OKR1eergz+o3uNvT+I1eNsAEAIwH+oc/okHwM0PjJ9WD4zXOv3R8XEQnDix8ZlJf78CoJAJgE+1efB7a0cXltfOLfRW/20ar8EdBYAQgHbazeGfegDcsE5/+F+dldHFKgheWnpl+PgkPnooAAqZALiue/6e6uA/Ur2uX6j+hn++ek//5yxeg7UCQAhAO+zl8M86AG5+gIz+p7MyvLT50cMqCLovf//zdb9/AVDIsgbAYyc+u3nwNz+St/baYm/1Z028BncVAEIAmjGJw994ANy8D7Z/9PCPz775q3f6fRAAhSxJADxw5NwXwmfwe6v/2/Trb88BIARgNiZ5+FsYAGHjn0XQWRm9vfnRwyoInhysf+nG3w8BUMgKDYCvfOvVL259Bn/8kbxL1a+/bPr1NrUAEAIwHdM4/G0PgFtHwSc/i2Bp5fKCAChkhQTAgWe/+0Ddz+C3YRMNACEAkzHNwz+PAXDjfvvPXv2w6YenABAA4/3Jd37wwW4+g9+GTSUAhADszUJvbW3ab/75DoDvNf7wFAACYDMATv2g8ddSKwPgkxBYa/p5CnNl84d9CAABUPoEQPEBMP6nu6afpzBXBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBIAAiAFBMAAgCIBIAASDEBIACASAAIgBQTAAIAiASAAEgxASAAgEgACIAUEwACAIgEgABIMQEgAIBooTf4RhUBbwoAAVD0BEDhATB8c+nM6BtNP09hDm3cfeC5tacWe6uXBUC1/ugn1a/nq1+PLv7p4KdNPzwFgAAYr7Ny+d8P9AbdKthPV3+u64vLq9eafm01HQCd/vCtzpnh893z5+9p+ikKc246IdD2AKgeIlfG//fh+EGytHJ5YfvvSPWQ/XHTD08BIACub/ju9tfmgWe/+8D4/VoFwcnNIOitXW36tTarAHD4YWomGwJtCoBOf/RhZ2X09ubB74+6Tw7Wv3S73wkBUMgKDIAbfeVbr37xQG/w+FYQXKp+/WXTr71JB4DDDzMzmRBoOAA+WOqP1quH58mlM2889fSp0f11fgcEQCFLEAA3euDIuS8cfG7w6GJv7XgVAxer18LP5zUAHH5ozFYIbP67Y7sDoPqb/X9Xu7R58F8ZPt59+fuf38t3LgAKWcIAuMljJz67v3f2ketBsPZaFfY/a30A9Ic/dPihFXYXAlMNgP7w/c7K6GKnPzr+zMobj3ZPvPUrk/yOBUAhEwA3656/56Fn/+bhKgiOLiyvnq/2H60JgK3Df+LExmcm+j0De1UvBCYbAMN3q722efDPXn5k2g8IAVDIBMCO7O+dPXg9CNbOVfvXmQeAww/zYmchsKcA+PgjecMXxgf/ro2Nu2f5HQqAQiYAduWhZ/u/tfXRw0EVBm9PLQAcfphXtw+BOgGw+ZG8/ujc+DP43VfeOND0dyYACpkAmIj9y4MHd/OzCD41ABx+KMWtQ+DTAqCzMrz68UfyqofA02d++FDT38GNBEAhEwBT8eXu935j288iuLTQW/2/HQWAww+liiGwLQCufySvPzo9/gx+9+W3fq3pr/ROBEAhEwAzcai7ct/WzyJ4afzRw4Xe2i9CADj8kMXG3dVDoPOHf/XPx7+5cvkPnhys39v0V1SXAChkAqARDx4d3Lv/yNnfP3T07/6iiv7OrP8bHoBdEwCFTAAAUIcAKGQCAIA6BEAhEwAA1CEACpkAAKAOAVDIBAAAdQiAQiYAAKhDABQyAQBAHQKgkAkAAOoQAIVMAABQhwAoZAIAgDoEQCETAADUIQAKmQAAoA4BUMgEAAB1CIBCJgAAqEMAFDIBAEAdAqCQCQAA6hAAhUwAAFCHAChkAgCAOgRAIRMAANQhAAqZAACgDgFQyAQAAHUIgEImAACoQwAUMgEAQB0Ly2vvNH3ABYAAGK/TH15p+v0AkMah7sp9i72144vLq+81fcgFQNIA6A/fr/72f/LpU6P7m34/AKQzzyHQ+PFtw+YxABx+gPaYxxBo/Pi2YfMUAA4/QHvNUwg0fnzbsHkIAIcfYH7MQwg0fnzbsDYHgMMPML/aHAKNH982rI0B4PADlKONIdD48W3D2hQADj9AudoUAo0f3zasDQHg8APk0YYQaPz4tmFNBoDDD5BXkyHQ+PFtw5oIAIcfgI80EQKNH982bJYB4PAD8GlmGQKNH982bBYB4PADsFOzCIHGj28bNs0AcPgB2K1phkDjx7cNm0YAOPwATMo0QqDx49uSOfwAtN4kQ6Dpw9uWOfwAzI1JhMDhY69fa/r4tmEOPwBzZy8hIADGu+DwAzC/dhMCAqBmADj8ALRVnRA4fOyCAPj2hWsOPwDF2EkICIA7BIDDD8C8ul0IHD72+tXmD3DTu0UAOPwAlOJWISAAbggAhx+AUm0PAQGwFQAOPwBZHOwO9h1+4R9/7/CL1h2s72v6zwMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAICM/h+XLErIryvnXAAAAABJRU5ErkJggg==';
}
